name: 'Build extension and create release'

on:
    workflow_dispatch:
    push:
        branches:
            - master
        paths:
            - 'package.json'

jobs:
    compile:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - uses: actions/setup-node@v2
              with:
                  node-version: 16
                  cache: 'yarn'
            - run: yarn install --frozen-lockfile
            - id: set_var
              run: |
                  content=`cat ./package.json`
                  # the following lines are only required for multi line json
                  content="${content//'%'/'%25'}"
                  content="${content//$'\n'/'%0A'}"
                  content="${content//$'\r'/'%0D'}"
                  # end of optional handling for multi line json
                  echo "::set-output name=packageJson::$content"
            - run: yarn run production
            - run: yarn run production:ff
            - name: Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: 'v${{fromJson(steps.set_var.outputs.packageJson).version}}'
                  generate_release_notes: true
                  files: |
                      dist/*.zip